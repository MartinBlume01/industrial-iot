name: industrial-iot

services:
  postgres:
    image: timescale/timescaledb:2.14.2-pg15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_change_me}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log

  chirpstack:
    image: chirpstack/chirpstack:4
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mosquitto:
        condition: service_started
    ports:
      - "${CHIRPSTACK_PORT:-8080}:8080"
    environment:
      CHIRPSTACK_LOG_LEVEL: ${CHIRPSTACK_LOG_LEVEL:-info}
      CHIRPSTACK_POSTGRESQL_DSN: ${CHIRPSTACK_POSTGRESQL_DSN:-postgres://chirpstack:chirpstack@postgres/chirpstack?sslmode=disable}
      CHIRPSTACK_REDIS_SERVERS: ${CHIRPSTACK_REDIS_SERVERS:-redis://redis/}
      CHIRPSTACK_NETWORK_ENABLED_REGIONS: ${CHIRPSTACK_NETWORK_ENABLED_REGIONS:-eu868}
      CHIRPSTACK_MQTT_SERVER: ${CHIRPSTACK_MQTT_SERVER:-tcp://mosquitto:1883}
      CHIRPSTACK_API_SECRET: ${CHIRPSTACK_API_SECRET:-replace-with-a-strong-secret}
    volumes:
      - ./chirpstack/chirpstack.toml:/etc/chirpstack/chirpstack.toml

  chirpstack-gateway-bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    depends_on:
      - mosquitto
    ports:
      - "${LORA_UDP_PORT:-1700}:1700/udp"
    command: ["-c", "/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml"]
    volumes:
      - ./gateway-bridge/chirpstack-gateway-bridge.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml

  iot-ingestor:
    image: ${IOT_INGESTOR_IMAGE:?Set_IOT_INGESTOR_IMAGE_to_a_valid_registry_image}
    pull_policy: always
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      mosquitto:
        condition: service_started
    environment:
      MQTT_BROKER: ${MQTT_BROKER:-mosquitto}
      MQTT_PORT: "${MQTT_INTERNAL_PORT:-1883}"
      MQTT_TOPIC: ${MQTT_TOPIC:-application/+/device/+/event/up}
      PG_HOST: ${PG_HOST:-postgres}
      PG_PORT: "${PG_PORT:-5432}"
      PG_DB: ${PG_DB:-iot}
      PG_USER: ${PG_USER:-iot_app}
      PG_PASSWORD: ${PG_PASSWORD:-iot_app}

  grafana:
    image: grafana/grafana-oss:10.4.3
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin_change_me}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards

volumes:
  postgres_data:
  mosquitto_data:
  mosquitto_log:
  grafana_data:
